// Code generated by protogen. DO NOT EDIT.

package {{.Package}}

import (
	"fmt"

	"github.com/VictoriaMetrics/easyproto"
)
{{if not .SkipHeader}}
var _mp easyproto.MarshalerPool

// ProtobufMarshaler is the interface for types that can marshal to protobuf.
// Implement this interface to use custom types as nested messages.
type ProtobufMarshaler interface {
	MarshalProtobufTo(mm *easyproto.MessageMarshaler)
}

// ProtobufUnmarshaler is the interface for types that can unmarshal from protobuf.
// Implement this interface to use custom types as nested messages.
type ProtobufUnmarshaler interface {
	UnmarshalProtobuf(src []byte) error
}
{{end}}
{{- range $typeName := .Types}}
{{- $info := index $.TypeInfos $typeName}}

// MarshalProtobuf marshals {{$typeName}} into protobuf message, appends this message to dst and returns the result.
//
func (x *{{$typeName}}) MarshalProtobuf(dst []byte) []byte {
	m := _mp.Get()
	x.MarshalProtobufTo(m.MessageMarshaler())
	dst = m.Marshal(dst)
	_mp.Put(m)
	return dst
}

// MarshalProtobufTo marshals {{$typeName}} fields to the given MessageMarshaler.
// Implements ProtobufMarshaler interface.
func (x *{{$typeName}}) MarshalProtobufTo(mm *easyproto.MessageMarshaler) {
{{- range $field := $info.Fields}}
{{- if $field.IsOneof}}
	switch v := x.{{$field.Name}}.(type) {
{{- range $v := $field.OneofVariants}}
	case *{{$v.TypeName}}:
		v.MarshalProtobufTo(mm.AppendMessage({{$v.FieldNum}}))
{{- end}}
	}
{{- else if $field.IsMap}}
	for k, v := range x.{{$field.Name}} {
		mm2 := mm.AppendMessage({{$field.FieldNum}})
		mm2.{{appendFunc $field.MapKeyProto false}}(1, k)
{{- if $field.MapValueIsMsg}}
{{- if $field.MapValueIsPtr}}
		if v != nil {
			v.MarshalProtobufTo(mm2.AppendMessage(2))
		}
{{- else}}
		v.MarshalProtobufTo(mm2.AppendMessage(2))
{{- end}}
{{- else}}
		mm2.{{appendFunc $field.MapValueProto false}}(2, v)
{{- end}}
	}
{{- else if $field.IsMessage}}
{{- if and $field.IsPointer (not $field.IsRepeated)}}
	if x.{{$field.Name}} != nil {
		x.{{$field.Name}}.MarshalProtobufTo(mm.AppendMessage({{$field.FieldNum}}))
	}
{{- else if and $field.IsRepeated $field.IsSliceOfPtr}}
	for _, v := range x.{{$field.Name}} {
		if v != nil {
			v.MarshalProtobufTo(mm.AppendMessage({{$field.FieldNum}}))
		}
	}
{{- else if $field.IsRepeated}}
	for i := range x.{{$field.Name}} {
		x.{{$field.Name}}[i].MarshalProtobufTo(mm.AppendMessage({{$field.FieldNum}}))
	}
{{- else}}
	x.{{$field.Name}}.MarshalProtobufTo(mm.AppendMessage({{$field.FieldNum}}))
{{- end}}
{{- else if $field.IsEnum}}
{{- if and $field.IsPointer (not $field.IsRepeated)}}
	if x.{{$field.Name}} != nil {
		mm.AppendInt32({{$field.FieldNum}}, int32(*x.{{$field.Name}}))
	}
{{- else if $field.IsRepeated}}
	for _, v := range x.{{$field.Name}} {
		mm.AppendInt32({{$field.FieldNum}}, int32(v))
	}
{{- else}}
	mm.AppendInt32({{$field.FieldNum}}, int32(x.{{$field.Name}}))
{{- end}}
{{- else if and $field.IsRepeated (isLengthDelimited $field.ProtoType)}}
	for _, v := range x.{{$field.Name}} {
		mm.{{appendFunc $field.ProtoType false}}({{$field.FieldNum}}, v)
	}
{{- else if and $field.IsPointer (not $field.IsRepeated)}}
	if x.{{$field.Name}} != nil {
		mm.{{appendFunc $field.ProtoType false}}({{$field.FieldNum}}, *x.{{$field.Name}})
	}
{{- else if $field.IsRepeated}}
	mm.{{appendFunc $field.ProtoType true}}({{$field.FieldNum}}, x.{{$field.Name}})
{{- else}}
	mm.{{appendFunc $field.ProtoType false}}({{$field.FieldNum}}, x.{{$field.Name}})
{{- end}}
{{- end}}
}

// UnmarshalProtobuf unmarshals {{$typeName}} from protobuf message at src.
func (x *{{$typeName}}) UnmarshalProtobuf(src []byte) (err error) {
	// Set default values
{{- range $field := $info.Fields}}
{{- if or $field.IsOneof $field.IsPointer}}
	x.{{$field.Name}} = nil
{{- else if $field.IsMap}}
	for k := range x.{{$field.Name}} {
		delete(x.{{$field.Name}}, k)
	}
{{- else if $field.IsRepeated}}
	x.{{$field.Name}} = x.{{$field.Name}}[:0]
{{- else if $field.IsEnum}}
	x.{{$field.Name}} = 0
{{- else}}
	x.{{$field.Name}} = {{zeroValue $field.GoType}}
{{- end}}
{{- end}}

	// Parse message
	var fc easyproto.FieldContext
	for len(src) > 0 {
		src, err = fc.NextField(src)
		if err != nil {
			return fmt.Errorf("cannot read next field in {{$typeName}}: %w", err)
		}
		switch fc.FieldNum {
{{- range $field := $info.Fields}}
{{- if $field.IsOneof}}
{{- range $v := $field.OneofVariants}}
		case {{$v.FieldNum}}:
			data, ok := fc.MessageData()
			if !ok {
				return fmt.Errorf("cannot read {{$typeName}}.{{$field.Name}} ({{$v.TypeName}}) data")
			}
			v := &{{$v.TypeName}}{}
			if err := v.UnmarshalProtobuf(data); err != nil {
				return fmt.Errorf("cannot unmarshal {{$typeName}}.{{$field.Name}} ({{$v.TypeName}}): %w", err)
			}
			x.{{$field.Name}} = v
{{- end}}
{{- else}}
		case {{$field.FieldNum}}:
{{- if $field.IsMap}}
			data, ok := fc.MessageData()
			if !ok {
				return fmt.Errorf("cannot read {{$typeName}}.{{$field.Name}} data")
			}
			var mk {{$field.MapKeyType}}
			var mv {{$field.MapValueType}}
			var fc2 easyproto.FieldContext
			for len(data) > 0 {
				data, err = fc2.NextField(data)
				if err != nil {
					return fmt.Errorf("cannot read {{$typeName}}.{{$field.Name}} entry: %w", err)
				}
				switch fc2.FieldNum {
				case 1:
					kv, ok := fc2.{{readFunc $field.MapKeyProto}}()
					if !ok {
						return fmt.Errorf("cannot read {{$typeName}}.{{$field.Name}} key")
					}
					mk = kv
				case 2:
{{- if $field.MapValueIsMsg}}
					vdata, ok := fc2.MessageData()
					if !ok {
						return fmt.Errorf("cannot read {{$typeName}}.{{$field.Name}} value data")
					}
{{- if $field.MapValueIsPtr}}
					mv = &{{trimPrefix $field.MapValueType "*"}}{}
{{- end}}
					if err := mv.UnmarshalProtobuf(vdata); err != nil {
						return fmt.Errorf("cannot unmarshal {{$typeName}}.{{$field.Name}} value: %w", err)
					}
{{- else}}
					vv, ok := fc2.{{readFunc $field.MapValueProto}}()
					if !ok {
						return fmt.Errorf("cannot read {{$typeName}}.{{$field.Name}} value")
					}
					mv = vv
{{- end}}
				}
			}
			if x.{{$field.Name}} == nil {
				x.{{$field.Name}} = make({{$field.GoType}})
			}
			x.{{$field.Name}}[mk] = mv
{{- else if $field.IsMessage}}
			data, ok := fc.MessageData()
			if !ok {
				return fmt.Errorf("cannot read {{$typeName}}.{{$field.Name}} data")
			}
{{- if and $field.IsPointer (not $field.IsRepeated)}}
			if x.{{$field.Name}} == nil {
				x.{{$field.Name}} = &{{$field.ElemType}}{}
			}
			if err := x.{{$field.Name}}.UnmarshalProtobuf(data); err != nil {
				return fmt.Errorf("cannot unmarshal {{$typeName}}.{{$field.Name}}: %w", err)
			}
{{- else if and $field.IsRepeated $field.IsSliceOfPtr}}
			item := &{{$field.ElemType}}{}
			if err := item.UnmarshalProtobuf(data); err != nil {
				return fmt.Errorf("cannot unmarshal {{$typeName}}.{{$field.Name}}: %w", err)
			}
			x.{{$field.Name}} = append(x.{{$field.Name}}, item)
{{- else if $field.IsRepeated}}
			x.{{$field.Name}} = append(x.{{$field.Name}}, {{$field.ElemType}}{})
			if err := x.{{$field.Name}}[len(x.{{$field.Name}})-1].UnmarshalProtobuf(data); err != nil {
				return fmt.Errorf("cannot unmarshal {{$typeName}}.{{$field.Name}}: %w", err)
			}
{{- else}}
			if err := x.{{$field.Name}}.UnmarshalProtobuf(data); err != nil {
				return fmt.Errorf("cannot unmarshal {{$typeName}}.{{$field.Name}}: %w", err)
			}
{{- end}}
{{- else if $field.IsEnum}}
{{- if and $field.IsPointer (not $field.IsRepeated)}}
			v, ok := fc.Int32()
			if !ok {
				return fmt.Errorf("cannot read {{$typeName}}.{{$field.Name}}")
			}
			tmp := {{$field.ElemType}}(v)
			x.{{$field.Name}} = &tmp
{{- else if $field.IsRepeated}}
			if v, ok := fc.Int32(); ok {
				x.{{$field.Name}} = append(x.{{$field.Name}}, {{$field.ElemType}}(v))
			} else {
				return fmt.Errorf("cannot read {{$typeName}}.{{$field.Name}}")
			}
{{- else}}
			v, ok := fc.Int32()
			if !ok {
				return fmt.Errorf("cannot read {{$typeName}}.{{$field.Name}}")
			}
			x.{{$field.Name}} = {{$field.BaseType}}(v)
{{- end}}
{{- else if and $field.IsPointer (not $field.IsRepeated)}}
			v, ok := fc.{{readFunc $field.ProtoType}}()
			if !ok {
				return fmt.Errorf("cannot read {{$typeName}}.{{$field.Name}}")
			}
			x.{{$field.Name}} = &v
{{- else if and $field.IsRepeated (isLengthDelimited $field.ProtoType)}}
			v, ok := fc.{{readFunc $field.ProtoType}}()
			if !ok {
				return fmt.Errorf("cannot read {{$typeName}}.{{$field.Name}}")
			}
			x.{{$field.Name}} = append(x.{{$field.Name}}, v)
{{- else if $field.IsRepeated}}
			var ok bool
			x.{{$field.Name}}, ok = fc.{{unpackFunc $field.ProtoType}}(x.{{$field.Name}})
			if !ok {
				return fmt.Errorf("cannot read {{$typeName}}.{{$field.Name}}")
			}
{{- else}}
			v, ok := fc.{{readFunc $field.ProtoType}}()
			if !ok {
				return fmt.Errorf("cannot read {{$typeName}}.{{$field.Name}}")
			}
			x.{{$field.Name}} = v
{{- end}}
{{- end}}
{{- end}}
		}
	}
	return nil
}
{{- end}}
